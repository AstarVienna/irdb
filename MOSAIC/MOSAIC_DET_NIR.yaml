### H4RG DETECTOR
object: detector
alias: DET
name: MOSAIC_DET_NIR
description: H4RG detector 2.5 um cut-off
date_modified: 2025-08-07
changes:
  - 2025-08-07 (OC) adapted from MICADO H4RG
properties:
  detector: HAWAII4RG
  image_plane_id: 0
  temperature: -230    # [deg Celsius]
  dit: "!OBS.dit"
  ndit: "!OBS.ndit"
  read_noise: 12       # [e rms] from MICADO
  dark_current: 0.05   # [e/s] conservative
  gain: 2.5            # [e/ADU] estimate
  full_well: 1.e+5     # [e]
  mindit: 1.3          # [s]
  layout:
    file_name: "FPA_mosaic_NIR_layout.dat"
  qe_curve:
    file_name: "QE_detector_NIR.dat"
  linearity:
    file_name: "FPA_linearity_HxRG.dat"

effects:
  - name: detector_array
    description: MOSAIC NIR detector array
    class: DetectorList
    kwargs:
      filename: "!DET.layout.file_name"

  - name: qe_curve
    description: Quantum efficiency curves for H4RG detector
    class: QuantumEfficiencyCurve
    kwargs:
      filename: "!DET.qe_curve.file_name"

  - name: auto_exposure
    description: automatic determination of DIT and NDIT
    class: AutoExposure
    include: true
    kwargs:
      fill_frac: 0.75     #"!OBS.auto_exposure.fill_frac"
      full_well: "!DET.full_well"
      mindit: "!DET.mindit"

  - name: exposure_integration
    description: Summing up sky signal for all DITs and NDITs
    class: ExposureIntegration

  - name: dark_current
    description: MICADO dark current
    class: DarkCurrent
    kwargs:
      value: "!DET.dark_current"

  - name: shot_noise
    description: apply poisson shot noise to images
    class: ShotNoise

  - name: detector_linearity
    description: Linearity characteristics of H4RG chips
    class: LinearityCurve
    kwargs:
      filename: "!DET.linearity.file_name"

  - name: border_reference_pixels
    description: Blanks the signal on N edge row and column pixels
    class: ReferencePixelBorder
    kwargs:
      all: 0

  - name: readout_noise
    description: Readout noise frames
    class: BasicReadoutNoise
    kwargs:
      noise_std: "!DET.read_noise"
      n_channels: 64

  - name: exposure_output
    description: Return average or sum over NDIT subexposures
    class: ExposureOutput
    kwargs:
      mode: sum

  - name: ad_conversion
    description: Apply gain and convert electron counts into integers
    class: ADConversion
    kwargs:
      dtype: float32
      gain: "!DET.gain"

  - name: collapse_1d
    description: Collapse fiber bundle to 1D spectrum
    class: MosaicCollapseSpectralTraces
    include:  "!OBS.do_collapse_1d"
    kwargs:
      filename: "!OBS.trace_file"

#  - name: det_nir_fits_keywords
#    description: FITS keywords specific to NIR detector
#    class: ExtraFitsKeywords
#    include: true
#    kwargs:
#      filename: headers/FITS_det_nir_keywords.yaml
